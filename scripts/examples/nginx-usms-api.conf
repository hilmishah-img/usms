# Nginx Reverse Proxy Configuration for USMS API
# ================================================
#
# This configuration file provides a production-ready setup for proxying
# the USMS API through Nginx with HTTPS, security headers, and best practices.
#
# Installation:
#   1. Copy this file to: /etc/nginx/sites-available/usms-api
#   2. Update server_name with your actual domain
#   3. Update SSL certificate paths
#   4. Create symlink: sudo ln -s /etc/nginx/sites-available/usms-api /etc/nginx/sites-enabled/
#   5. Test config: sudo nginx -t
#   6. Reload: sudo systemctl reload nginx
#
# Requirements:
#   - Nginx 1.18+ (for HTTP/2 support)
#   - SSL certificate (use Let's Encrypt)
#   - USMS API running on localhost:8000

# Upstream configuration for USMS API backend
upstream usms_api_backend {
    # Single instance (default)
    server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;

    # Multiple instances for load balancing (uncomment if needed)
    # server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
    # server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;

    # Load balancing method (choose one)
    # least_conn;    # Route to server with fewest active connections
    # ip_hash;       # Sticky sessions based on client IP
    # round_robin;   # Default - distribute requests evenly

    # Health check settings
    keepalive 32;  # Keep connections open for reuse
}

# Rate limiting zones
# These complement the API's built-in rate limiting
limit_req_zone $binary_remote_addr zone=api_login:10m rate=5r/m;  # Login attempts
limit_req_zone $binary_remote_addr zone=api_general:10m rate=60r/m;  # General API calls
limit_req_status 429;  # HTTP status for rate limit exceeded

# HTTP server - Redirect all HTTP traffic to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name api.yourdomain.com;

    # ACME challenge for Let's Encrypt certificate renewal
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other HTTP requests to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server - Main configuration
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.yourdomain.com;

    # =========================================================================
    # SSL/TLS Configuration
    # =========================================================================

    # SSL certificate paths (update with your actual paths)
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;

    # SSL protocols and ciphers (modern, secure configuration)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session settings for performance
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP stapling for certificate validation
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/api.yourdomain.com/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # =========================================================================
    # Security Headers
    # =========================================================================

    # Strict-Transport-Security: Force HTTPS for 1 year
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # X-Frame-Options: Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # X-Content-Type-Options: Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # X-XSS-Protection: Enable XSS filter
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer-Policy: Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions-Policy: Restrict browser features
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Content-Security-Policy: Prevent XSS and injection attacks
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'self';" always;

    # =========================================================================
    # Logging
    # =========================================================================

    # Access log with detailed format
    access_log /var/log/nginx/usms-api-access.log combined;

    # Error log
    error_log /var/log/nginx/usms-api-error.log warn;

    # =========================================================================
    # General Settings
    # =========================================================================

    # Maximum client body size (for POST requests)
    client_max_body_size 10M;

    # Buffer settings
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;

    # Timeouts
    client_body_timeout 60s;
    client_header_timeout 60s;
    send_timeout 60s;

    # Disable unnecessary access log for static files
    location ~* \.(ico|css|js|gif|jpeg|jpg|png|woff|woff2|ttf|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # =========================================================================
    # API Endpoints
    # =========================================================================

    # Health check endpoint (no rate limiting, no logging)
    location = /health {
        proxy_pass http://usms_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # No access logging for health checks
        access_log off;

        # Quick timeout for health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Authentication endpoints (strict rate limiting)
    location ~ ^/auth/(login|refresh) {
        # Apply strict rate limiting (5 requests/min per IP)
        limit_req zone=api_login burst=10 nodelay;

        proxy_pass http://usms_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeouts for auth endpoints
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # API documentation endpoints (public access)
    location ~ ^/(docs|redoc|openapi.json) {
        proxy_pass http://usms_api_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Allow larger payload for API docs
        client_max_body_size 5M;
    }

    # General API endpoints (moderate rate limiting)
    location / {
        # Apply general rate limiting (60 requests/min per IP)
        limit_req zone=api_general burst=20 nodelay;

        proxy_pass http://usms_api_backend;
        proxy_http_version 1.1;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header Connection "";

        # WebSocket support (for future use)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Prevent proxying errors from showing upstream info
        proxy_intercept_errors on;
    }

    # =========================================================================
    # Error Pages
    # =========================================================================

    # Custom error pages (optional)
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        internal;
        return 404 '{"detail": "Not found", "error_code": "NOT_FOUND"}';
        add_header Content-Type application/json always;
    }

    location = /50x.html {
        internal;
        return 500 '{"detail": "Internal server error", "error_code": "INTERNAL_ERROR"}';
        add_header Content-Type application/json always;
    }

    # =========================================================================
    # Security: Block unwanted access
    # =========================================================================

    # Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block access to backup files
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# Additional Notes
# ============================================================================
#
# Performance Tuning:
#   - Adjust worker_processes in nginx.conf (typically = CPU cores)
#   - Tune worker_connections (default 1024, increase for high traffic)
#   - Enable gzip compression in nginx.conf
#   - Consider using nginx caching for static responses
#
# Monitoring:
#   - Enable nginx stub_status module for metrics
#   - Set up log rotation (logrotate)
#   - Monitor error logs regularly
#   - Use monitoring tools (Prometheus + Grafana, Datadog, etc.)
#
# Load Balancing:
#   - Uncomment multiple backend servers in upstream block
#   - Choose appropriate load balancing algorithm
#   - Configure health checks (nginx-plus or external tools)
#
# SSL Certificate Management:
#   - Use certbot for automatic Let's Encrypt renewal:
#     sudo certbot --nginx -d api.yourdomain.com
#   - Test auto-renewal: sudo certbot renew --dry-run
#   - Certificates auto-renew via systemd timer or cron
#
# Testing:
#   - Test config: sudo nginx -t
#   - Reload without downtime: sudo systemctl reload nginx
#   - Check SSL: https://www.ssllabs.com/ssltest/
#   - Test headers: curl -I https://api.yourdomain.com
